
<p align="center">
  <img src="https://nestjs.com/img/logo-small.svg" width="120" alt="Nest Logo" />
  <h1 align="center">Prometheus Betting Engine</h1>
  <p align="center">A decentralized, autonomous, pool-based betting system powered by AI and Consensus Oracles.</p>
</p>

## Overview

The Prometheus Betting Engine is a modular, event-driven platform that automates the entire lifecycle of a sports betting market. Unlike traditional bookmakers that rely on manual odds setting and resulting, Prometheus uses:

1.  **AI Agents (LLMs)** to generate dynamic, sport-specific markets (e.g., "Will Real Madrid win by more than 2 goals?").
2.  **Consensus Oracles** to verify real-world outcomes by cross-referencing multiple independent data sources.
3.  **Pool-Based Betting** to ensure transparent payouts where winners share the total stake pool.

## System Architecture

The system is built on **NestJS** using a modular Monorepo architecture. It leverages **Prisma** for data persistence and **Playwright** for real-time data acquisition.

```mermaid
graph TD
    User[User Client] -->|Place Bet| BettingService
    User -->|Deposit/Withdraw| WalletService
    
    subgraph "Core Engine"
        MarketModule -->|Manages| MarketLifecycle[Lifecycle (Open/Lock/Result)]
        BettingModule -->|Calculates| Payouts[Pool Settlement]
        UserModule -->|Auth| Identity[User Identity]
    end

    subgraph "Intelligence Layer"
        ScraperModule -->|Ingests| LiveData[Live Scores]
        OracleService -->|Verifies| Consensus[Consensus Result]
        LlmService -->|Generates| Markets[Market Definitions]
        LlmService -->|Judges| Settlement[Outcome Decision]
    end

    subgraph "Data Sources"
        Flashscore
        SofaScore
        LiveScore
        BBC_Sport
    end

    ScraperModule -- Scrapes --> Flashscore
    OracleService -- Polls --> Flashscore
    OracleService -- Polls --> SofaScore
    OracleService -- Polls --> LiveScore
    OracleService -- Polls --> BBC_Sport
    
    MarketLifecycle -- Triggers --> OracleService
    OracleService -- Feeds --> LlmService
    LlmService -- Settle Command --> BettingModule
```

## Core Modules

### 1. Scraper Module (`src/scraper`)
Responsible for discovering events and acquiring data.
*   **Ingestion**: Iterates through multiple sports (Football, Tennis, Basketball, Cricket, Rugby, Volleyball) on Flashscore to find scheduled matches.
*   **Oracle Service**: The "Truth Verification" layer. When a match ends, it polls 4 independent adapters (`Flashscore`, `SofaScore`, `LiveScore`, `BBC`) to reach a consensus on the final score, preventing single-source-of-failure or manipulation.

### 2. Market Module (`src/market`)
Manages the state machine of every event.
*   **Cron Jobs**: Runs every minute to check for events that have started (`OPEN` -> `LOCKED`) or finished.
*   **Lifecycle**:
    *   **Scheduled**: Event created, Markets generated by AI.
    *   **In-Play**: Markets locked, betting closed.
    *   **Finished**: Oracle verifies score -> LLM determines winning outcome -> Bets settled.

### 3. LLM Module (`src/llm`)
The "Brain" of the operation.
*   **Market Generation**: Analyzes team names and sport context to create engaging, human-readable markets.
*   **Result Judgment**: Takes the raw score (e.g., "2-1") and the market name (e.g., "Home Team to win?") to deterministically decide the winner.

### 4. Betting & Wallet Module (`src/betting`, `src/wallet`)
Handles the financial logic.
*   **Wallet**: Simple ledger system for user balances.
*   **Pool Logic**: Implements a Pari-Mutuel style payout.
    *   `WinnerPayout = Stake + (Stake / TotalWinnerPool) * TotalLoserPool`

## Installation & Setup

### Prerequisites
*   Node.js v16+
*   NPM or Yarn
*   OpenRouter API Key (for LLM services)

### Steps

1.  **Install Dependencies**
    ```bash
    npm install
    npx playwright install chromium
    ```

2.  **Environment Configuration**
    Create a `.env` file in the root directory:
    ```env
    DATABASE_URL="file:./dev.db"
    OPENROUTER_API_KEY="your_api_key_here"
    ```

3.  **Database Initialization**
    ```bash
    npx prisma migrate dev
    npx prisma generate
    ```

4.  **Run the Application**
    ```bash
    npm run start
    ```

## API Usage

### Scraper/Oracle Testing
*   **Ingest All Sports**: `GET /scraper/ingest-all`
*   **Test Oracle Consensus**: `GET /scraper/test-oracle?home=TeamA&away=TeamB`

### User Operations
*   **Register**: `POST /user/register` `{ "username": "...", "email": "...", "password": "..." }`
*   **Deposit**: `POST /wallet/deposit` `{ "userId": "...", "amount": 100 }`
*   **Place Bet**: `POST /betting/place` `{ "userId": "...", "marketId": "...", "outcome": "...", "stake": 10 }`

## Technologies Used

*   **Framework**: NestJS
*   **Language**: TypeScript
*   **Database**: SQLite (via Prisma)
*   **Browser Automation**: Playwright
*   **AI**: OpenRouter (Unified Interface for LLMs)
